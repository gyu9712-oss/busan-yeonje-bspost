<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Open-Meteo 날씨 지도 — 부산 연제 (이륜차 예방수칙)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root { --bg:#fff; --ink:#111; --muted:#666; --card:rgba(255,255,255,.95); --shadow:0 2px 10px rgba(0,0,0,.1); --bd:#e5e7eb; }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0b0f14; --ink:#e6edf3; --muted:#9aa4af; --card:rgba(20,24,30,.9); --shadow:0 2px 12px rgba(0,0,0,.35); --bd:#263244; }
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); }
    #map { height:100vh; outline:none; }
    .legend, .toolbar {
      position:absolute; z-index:1000; background:var(--card); padding:8px 10px; border-radius:10px;
      box-shadow:var(--shadow); font:13px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px); border:1px solid var(--bd);
    }
    .legend { right:12px; bottom:12px; max-width:240px; }
    .legend div { display:flex; align-items:center; gap:6px; margin:3px 0; }
    .legend .sw { width:10px; height:10px; border-radius:2px; display:inline-block; border:1px solid rgba(0,0,0,.08) }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; color:#fff; font-size:12px }
    .muted { color:var(--muted); font-size:12px }
    pre { white-space:pre-wrap; margin:6px 0 0; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .toolbar { left:12px; top:12px; display:flex; align-items:center; gap:8px; }
    .toolbar button{ cursor:pointer; border:1px solid var(--bd); background:transparent; padding:7px 12px; border-radius:10px; font-weight:600; color:var(--ink); }
    .toolbar button[aria-busy="true"]{ opacity:.65; cursor:progress }
    .toolbar button:focus-visible { outline:2px solid #60a5fa; outline-offset:2px; }
  </style>
</head>
<body>
  <div id="map" aria-label="부산 연제 날씨 지도"></div>

  <div class="toolbar" role="region" aria-label="도구">
    <button id="refreshBtn" type="button" title="새로고침 (R)" aria-live="polite">↻ 새로고침</button>
    <button id="locateBtn" type="button" title="내 위치로 이동">📍 내 위치</button>
    <span id="updated" class="muted">업데이트 대기…</span>
  </div>

  <div class="legend" role="note" aria-label="위험도 범례">
    <b>위험도</b>
    <div><span class="sw" style="background:#10b981"></span> 낮음</div>
    <div><span class="sw" style="background:#3b82f6"></span> 보통</div>
    <div><span class="sw" style="background:#f59e0b"></span> 주의</div>
    <div><span class="sw" style="background:#dc2626"></span> 경계</div>
    <div><span class="sw" style="background:#b91c1c"></span> 심각</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
  <script>
    // --- 설정/상수 -----------------------------------------------------------
    const KST = 'Asia/Seoul';
    const FETCH_TIMEOUT_MS = 12000;
    const MAP_CENTER = [35.1941016, 129.0706216]; // 부산 연제
    const OPEN_METEO = ({lat, lon}) =>
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
      + `&models=kma_seamless&current=temperature_2m,relative_humidity_2m,is_day,weather_code,rain,showers,snowfall,wind_speed_10m`
      + `&timezone=${encodeURIComponent(KST)}&windspeed_unit=ms`;

    const cities = [{ name: "부산 연제", lat: MAP_CENTER[0], lon: MAP_CENTER[1] }];

    // --- 유틸 --------------------------------------------------------------
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmt = (n, dp=0) => (n===undefined || n===null || Number.isNaN(n)) ? '-' : Number(n).toFixed(dp);
    const nowStr = () => new Date().toLocaleString('ko-KR', { timeZone: KST });

    function withTimeoutAbort(fetchFn, ms){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort('timeout'), ms);
      return fetchFn(controller.signal).finally(() => clearTimeout(id));
    }

    function weatherFromCode(code) {
      if (code === 0) return { main: "Clear", description: "맑음" };
      if ([1,2,3].includes(code)) return { main: "Clouds", description: code===1?"대체로 맑음": (code===2?"부분 흐림":"흐림") };
      if ([45,48].includes(code)) return { main: "Fog", description: "안개/짙은 안개" };
      if ([51,53,55,56,57].includes(code)) return { main: "Drizzle", description: "이슬비/언 이슬비" };
      if ([61,63,65,66,67,80,81,82].includes(code)) return { main: "Rain", description: "비/소나기" };
      if ([71,73,75,77,85,86].includes(code)) return { main: "Snow", description: "눈/소낙눈" };
      if ([95,96,99].includes(code)) return { main: "Thunderstorm", description: "뇌우" };
      return { main: "Clouds", description: "흐림" };
    }

    function colorForLevel(level) {
      return level === "심각" ? "#b91c1c"
           : level === "경계" ? "#dc2626"
           : level === "주의" ? "#f59e0b"
           : level === "보통" ? "#3b82f6"
           : "#10b981";
    }

    // --- 핵심: 위험도 평가 + (신규) 강풍 안전사고 정보 -----------------------
    function assessHazard({ main, tempC, windMs, rainMm, snowMm }) {
      let level = "보통";
      let type = new Set([main]);
      let tips = [];
      let incident = null; // 🔸 추가: 안전사고 정보 컨테이너

      const adopt = (lvl, typ, arr) => {
        const order = ["낮음","보통","주의","경계","심각"];
        if (order.indexOf(lvl) > order.indexOf(level)) level = lvl;
        if (typ) type.add(typ);
        if (arr && arr.length) tips.push(...arr);
      };

      if (main === "Thunderstorm") {
        adopt(rainMm > 20 ? "심각" : "경계", "뇌우/호우", [
          "강한 비·번개 시 운행 중지, 실내 대기",
          "지하차도·하천 인근 침수 도로 진입 금지",
          "시야 급감: 속도 30% 감속(비상등은 정차 시 사용)"
        ]);
      } else if (main === "Rain" || main === "Drizzle") {
        adopt(rainMm > 30 ? "심각" : (rainMm > 10 ? "경계" : "주의"), "비/젖은 노면", [
          "감속(평소 대비 20~30%), 제동거리 2배",
          "맨홀·도색·철판·빗물받이 위 통과 금지",
          "헬멧 김서림 방지, 방수 장갑 착용"
        ]);
      } else if (main === "Snow") {
        adopt(snowMm > 5 ? "경계" : "주의", "대설/결빙", [
          "블랙아이스 시간대 운행 자제·근무시간 조정",
          "급가감속 금지, 직진 시 후륜 제동 비중 낮추기",
          "방한 장비 착용, 체온 저하 시 즉시 휴식"
        ]);
      } else if (main === "Fog") {
        adopt("주의", "안개/박무", [
          "저속 주행, 상시 로우빔/안개등",
          "차로 변경 최소화, 차간거리 4초+",
          "교량·해안가 등 시정 악화 구간 회피"
        ]);
      } else if (main === "Clear") {
        if (tempC >= 35) {
          adopt("경계", "폭염", [
            "30~60분 간격 그늘 휴식·수분 보충",
            "통풍형 자켓/이너, 쿨링 타월 활용",
            "어지럼·두통 등 열질환 징후 시 즉시 중지"
          ]);
        } else if (tempC >= 33) {
          adopt("주의", "폭염", [
            "그늘 휴식·수분 보충",
            "진한 색/두꺼운 장비 피하기",
            "카페인 과다섭취 자제"
          ]);
        } else if (tempC <= -10) {
          adopt("경계", "한파", [
            "핸들워머/토시·핫팩으로 손 감각 유지",
            "아침 교량·그늘길 블랙아이스 주의, 서행",
            "시동 전 타이어 공기압·균열 점검"
          ]);
        } else {
          adopt("낮음", "맑음", [ "PPE(풀페이스 헬멧·장갑·부츠·보호대) 필수 착용" ]);
        }
      } else if (main === "Clouds") {
        adopt("보통", "구름/건조 노면", [ "규정 속도·차간거리 3초 이상, 피로 누적 시 휴식" ]);
      }

      // 🔸 추가 규칙: 강풍 시(14 m/s 이상) 안전사고 정보 부여
      if (windMs >= 14) {
        const windLevel = windMs >= 20 ? "심각" : "경계";
        adopt(windLevel, "강풍/돌풍", [
          "횡풍 구간(교량·해안·고가) 회피, 통과 시 저속·차로 중앙",
          "대형차 추월 금지(와류 위험), 적재물 재결속",
          "차체를 바람 방향으로 약간 기울여 균형 유지"
        ]);

        // ✅ 요구사항 반영: 사고 건수 및 사례 텍스트
        incident = {
          count: 1,
          case:
            "우편물 배송을 위해 이동중, 갑작스런 강풍으로 이륜차와 함께 옆으로 넘어져 오른쪽 손목 염좌 발생"
        };
      }

      tips.push("공통: T-CLOCS 점검, PPE 착용, 차간거리 3~4초, 적재 균형 유지");
      return { level, type: Array.from(type).join(" · "), tips: Array.from(new Set(tips)), incident };
    }

    // --- 지도 초기화 --------------------------------------------------------
    const map = L.map('map', { zoomControl: true }).setView(MAP_CENTER, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    L.control.scale({ metric: true, imperial: false }).addTo(map);

    const markerLayer = L.layerGroup().addTo(map);
    const circleLayer = L.layerGroup().addTo(map);
    const updatedEl = document.getElementById('updated');
    const refreshBtn = document.getElementById('refreshBtn');
    const locateBtn = document.getElementById('locateBtn');

    function cityPopup({name, wc, temp, humidity, wind, rain, snow, hazard}) {
      const badge = `<span class="badge" style="background:${colorForLevel(hazard.level)}">${hazard.level}</span>`;
      const tipsHtml = hazard.tips.map(t => `- ${t}`).join('\n');

      // 🔸 incident 블록이 있을 때만 렌더
      const incidentHtml = hazard.incident ? `
        <hr style="border:none;border-top:1px solid var(--bd);margin:8px 0"/>
        <b>⚠️ 안전사고</b> : <b>${hazard.incident.count}건</b><br/>
        <div style="margin-top:4px">사고사례 : ${hazard.incident.case}</div>
      ` : '';

      return `📍 <b>${name}</b><br/>
        🌤️ 상태: ${wc.description}
        <span style="display:inline-block;padding:2px 6px;border-radius:10px;border:1px solid #cfe;color:#456;background:#eef;margin-left:4px">${wc.main}</span><br/>
        🌡️ 기온: <b>${fmt(temp,0)}°C</b> · 💧 습도: ${fmt(humidity,0)}% · 🌬️ 풍속: <b>${fmt(wind,1)} m/s</b><br/>
        🌧️ 강수(현재): ${fmt(rain,1)} mm · ❄️ 적설(현재): ${fmt(snow,1)} mm<br/><br/>
        <b>🛡️ 이륜차 예방책</b> ${badge}<br/>
        상황 분류: <b>${hazard.type}</b>
        <pre>${tipsHtml}</pre>
        ${incidentHtml}
        <div class="muted" style="margin-top:6px">* 데이터: Open-Meteo(kma_seamless) · 시간대: ${KST}</div>`;
    }

    async function fetchCityWeather(city, retries=1) {
      const url = OPEN_METEO(city);
      try {
        const res = await withTimeoutAbort((signal) => fetch(url, { signal }), FETCH_TIMEOUT_MS);
        if (!res.ok) throw new Error(`Open-Meteo 응답 오류: ${res.status}`);
        const data = await res.json();
        const cur = data.current || {};
        const wc = weatherFromCode(cur.weather_code ?? 3);
        const temp = Number(cur.temperature_2m);
        const humidity = Number(cur.relative_humidity_2m);
        const wind = Number(cur.wind_speed_10m);
        const rain = Math.max(Number(cur.rain ?? 0), Number(cur.showers ?? 0));
        const snow = Number(cur.snowfall ?? 0);
        const hazard = assessHazard({ main: wc.main, tempC: temp, windMs: wind, rainMm: rain, snowMm: snow });
        return { wc, temp, humidity, wind, rain, snow, hazard };
      } catch (e) {
        if (retries > 0) {
          await sleep(400 + Math.random()*600);
          return fetchCityWeather(city, retries-1);
        }
        throw e;
      }
    }

    function drawCity(city, info) {
      const marker = L.marker([city.lat, city.lon]).addTo(markerLayer);
      marker.bindPopup(cityPopup({ name: city.name, ...info }));
      const r = 16;
      const color = colorForLevel(info.hazard.level);
      L.circleMarker([city.lat, city.lon], { radius: r, color, fillColor: color, fillOpacity: 0.25 }).addTo(circleLayer);
    }

    async function render(batch = cities) {
      markerLayer.clearLayers();
      circleLayer.clearLayers();
      updatedEl.textContent = '불러오는 중…';
      refreshBtn.setAttribute('aria-busy', 'true');

      for (const city of batch) {
        try {
          const info = await fetchCityWeather(city);
          drawCity(city, info);
        } catch (e) {
          const m = L.marker([city.lat, city.lon]).addTo(markerLayer);
          m.bindPopup(`❌ <b>${city.name}</b><br/>날씨 정보를 불러올 수 없습니다.<br/><span class="muted">${e?.message??e}</span>`);
        }
        await sleep(120);
      }

      updatedEl.textContent = `업데이트: ${nowStr()}`;
      refreshBtn.removeAttribute('aria-busy');
    }

    // --- 이벤트 -------------------------------------------------------------
    refreshBtn.addEventListener('click', () => render());
    window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'r') render(); });

    locateBtn.addEventListener('click', () => {
      if (!navigator.geolocation) return alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 13, { animate: true });
        },
        () => alert('위치 접근이 거부되었거나 실패했습니다.')
      );
    });

    // 초기 렌더
    render();
  </script>
</body>
</html>
필요하시면 안전사고 블록을 상단에 강조배지로 고정(항상 보이게) 하거나, **풍속 기준값(14 m/s)**을 옵션으로 바꿔 설정 파일에서 조정 가능하게 만들어드릴게요.







나의 말:
코드가 열리지 않아요 다시 한번 코드를 확인해주세요


ChatGPT의 말:

10s 동안 생각함
확인해보니, 이전 코드가 Leaflet 스크립트 로드 타이밍과 겹치면 L이 아직 정의되지 않아 실행이 멈출 수 있어요. 이번 버전은 페이지 로드 완료(window.load) 이후에만 초기화하도록 바꿨습니다. 또한 외부 스크립트/스타일 주소도 그대로 유효합니다.

아래 파일 하나로 교체해 실행해보세요. (풍속 14 m/s 이상이면 팝업에 안전사고 : 1건 / 사고사례 : ...가 표시됩니다.)

html
코드 복사
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Open-Meteo 날씨 지도 — 부산 연제 (이륜차 예방수칙)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root { --bg:#fff; --ink:#111; --muted:#666; --card:rgba(255,255,255,.95); --shadow:0 2px 10px rgba(0,0,0,.1); --bd:#e5e7eb; }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0b0f14; --ink:#e6edf3; --muted:#9aa4af; --card:rgba(20,24,30,.9); --shadow:0 2px 12px rgba(0,0,0,.35); --bd:#263244; }
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); }
    #map { height:100vh; outline:none; }
    .legend, .toolbar {
      position:absolute; z-index:1000; background:var(--card); padding:8px 10px; border-radius:10px;
      box-shadow:var(--shadow); font:13px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px); border:1px solid var(--bd);
    }
    .legend { right:12px; bottom:12px; max-width:260px; }
    .legend div { display:flex; align-items:center; gap:6px; margin:3px 0; }
    .legend .sw { width:10px; height:10px; border-radius:2px; display:inline-block; border:1px solid rgba(0,0,0,.08) }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; color:#fff; font-size:12px }
    .muted { color:var(--muted); font-size:12px }
    pre { white-space:pre-wrap; margin:6px 0 0; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .toolbar { left:12px; top:12px; display:flex; align-items:center; gap:8px; }
    .toolbar button{ cursor:pointer; border:1px solid var(--bd); background:transparent; padding:7px 12px; border-radius:10px; font-weight:600; color:var(--ink); }
    .toolbar button[aria-busy="true"]{ opacity:.65; cursor:progress }
    .toolbar button:focus-visible { outline:2px solid #60a5fa; outline-offset:2px; }
  </style>
</head>
<body>
  <div id="map" aria-label="부산 연제 날씨 지도"></div>

  <div class="toolbar" role="region" aria-label="도구">
    <button id="refreshBtn" type="button" title="새로고침 (R)" aria-live="polite">↻ 새로고침</button>
    <button id="locateBtn" type="button" title="내 위치로 이동">📍 내 위치</button>
    <span id="updated" class="muted">업데이트 대기…</span>
  </div>

  <div class="legend" role="note" aria-label="위험도 범례">
    <b>위험도</b>
    <div><span class="sw" style="background:#10b981"></span> 낮음</div>
    <div><span class="sw" style="background:#3b82f6"></span> 보통</div>
    <div><span class="sw" style="background:#f59e0b"></span> 주의</div>
    <div><span class="sw" style="background:#dc2626"></span> 경계</div>
    <div><span class="sw" style="background:#b91c1c"></span> 심각</div>
  </div>

  <!-- Leaflet는 그대로 defer로 로드 -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>

  <!-- 핵심 스크립트: window.load 이후에만 실행되도록 보장 -->
  <script>
  window.addEventListener('load', () => {
    // --- 설정/상수 -----------------------------------------------------------
    const KST = 'Asia/Seoul';
    const FETCH_TIMEOUT_MS = 12000;
    const MAP_CENTER = [35.1941016, 129.0706216]; // 부산 연제
    const OPEN_METEO = ({lat, lon}) =>
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
      + `&models=kma_seamless&current=temperature_2m,relative_humidity_2m,is_day,weather_code,rain,showers,snowfall,wind_speed_10m`
      + `&timezone=${encodeURIComponent(KST)}&windspeed_unit=ms`;

    const cities = [{ name: "부산 연제", lat: MAP_CENTER[0], lon: MAP_CENTER[1] }];

    // --- 유틸 --------------------------------------------------------------
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmt = (n, dp=0) => (n===undefined || n===null || Number.isNaN(n)) ? '-' : Number(n).toFixed(dp);
    const nowStr = () => new Date().toLocaleString('ko-KR', { timeZone: KST });

    function withTimeoutAbort(fetchFn, ms){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort('timeout'), ms);
      return fetchFn(controller.signal).finally(() => clearTimeout(id));
    }

    function weatherFromCode(code) {
      if (code === 0) return { main: "Clear", description: "맑음" };
      if ([1,2,3].includes(code)) return { main: "Clouds", description: code===1?"대체로 맑음": (code===2?"부분 흐림":"흐림") };
      if ([45,48].includes(code)) return { main: "Fog", description: "안개/짙은 안개" };
      if ([51,53,55,56,57].includes(code)) return { main: "Drizzle", description: "이슬비/언 이슬비" };
      if ([61,63,65,66,67,80,81,82].includes(code)) return { main: "Rain", description: "비/소나기" };
      if ([71,73,75,77,85,86].includes(code)) return { main: "Snow", description: "눈/소낙눈" };
      if ([95,96,99].includes(code)) return { main: "Thunderstorm", description: "뇌우" };
      return { main: "Clouds", description: "흐림" };
    }

    function colorForLevel(level) {
      return level === "심각" ? "#b91c1c"
           : level === "경계" ? "#dc2626"
           : level === "주의" ? "#f59e0b"
           : level === "보통" ? "#3b82f6"
           : "#10b981";
    }

    // --- 위험도 평가 (+ 강풍 안전사고 블록) ---------------------------------
    function assessHazard({ main, tempC, windMs, rainMm, snowMm }) {
      let level = "보통";
      let type = new Set([main]);
      let tips = [];
      let incident = null; // 14 m/s 이상시 채워짐

      const adopt = (lvl, typ, arr) => {
        const order = ["낮음","보통","주의","경계","심각"];
        if (order.indexOf(lvl) > order.indexOf(level)) level = lvl;
        if (typ) type.add(typ);
        if (arr && arr.length) tips.push(...arr);
      };

      if (main === "Thunderstorm") {
        adopt(rainMm > 20 ? "심각" : "경계", "뇌우/호우", [
          "강한 비·번개 시 운행 중지, 실내 대기",
          "지하차도·하천 인근 침수 도로 진입 금지",
          "시야 급감: 속도 30% 감속(비상등은 정차 시 사용)"
        ]);
      } else if (main === "Rain" || main === "Drizzle") {
        adopt(rainMm > 30 ? "심각" : (rainMm > 10 ? "경계" : "주의"), "비/젖은 노면", [
          "감속(평소 대비 20~30%), 제동거리 2배",
          "맨홀·도색·철판·빗물받이 위 통과 금지",
          "헬멧 김서림 방지, 방수 장갑 착용"
        ]);
      } else if (main === "Snow") {
        adopt(snowMm > 5 ? "경계" : "주의", "대설/결빙", [
          "블랙아이스 시간대 운행 자제·근무시간 조정",
          "급가감속 금지, 직진 시 후륜 제동 비중 낮추기",
          "방한 장비 착용, 체온 저하 시 즉시 휴식"
        ]);
      } else if (main === "Fog") {
        adopt("주의", "안개/박무", [
          "저속 주행, 상시 로우빔/안개등",
          "차로 변경 최소화, 차간거리 4초+",
          "교량·해안가 등 시정 악화 구간 회피"
        ]);
      } else if (main === "Clear") {
        if (tempC >= 35) {
          adopt("경계", "폭염", [
            "30~60분 간격 그늘 휴식·수분 보충",
            "통풍형 자켓/이너, 쿨링 타월 활용",
            "어지럼·두통 등 열질환 징후 시 즉시 중지"
          ]);
        } else if (tempC >= 33) {
          adopt("주의", "폭염", [
            "그늘 휴식·수분 보충",
            "진한 색/두꺼운 장비 피하기",
            "카페인 과다섭취 자제"
          ]);
        } else if (tempC <= -10) {
          adopt("경계", "한파", [
            "핸들워머/토시·핫팩으로 손 감각 유지",
            "아침 교량·그늘길 블랙아이스 주의, 서행",
            "시동 전 타이어 공기압·균열 점검"
          ]);
        } else {
          adopt("낮음", "맑음", [ "PPE(풀페이스 헬멧·장갑·부츠·보호대) 필수 착용" ]);
        }
      } else if (main === "Clouds") {
        adopt("보통", "구름/건조 노면", [ "규정 속도·차간거리 3초 이상, 피로 누적 시 휴식" ]);
      }

      // 강풍 조건(14 m/s 이상)
      if (windMs >= 14) {
        const windLevel = windMs >= 20 ? "심각" : "경계";
        adopt(windLevel, "강풍/돌풍", [
          "횡풍 구간(교량·해안·고가) 회피, 통과 시 저속·차로 중앙",
          "대형차 추월 금지(와류 위험), 적재물 재결속",
          "차체를 바람 방향으로 약간 기울여 균형 유지"
        ]);
        incident = {
          count: 1,
          case: "우편물 배송을 위해 이동중, 갑작스런 강풍으로 이륜차와 함께 옆으로 넘어져 오른쪽 손목 염좌 발생"
        };
      }

      tips.push("공통: T-CLOCS 점검, PPE 착용, 차간거리 3~4초, 적재 균형 유지");
      return { level, type: Array.from(type).join(" · "), tips: Array.from(new Set(tips)), incident };
    }

    // --- 지도 초기화 --------------------------------------------------------
    const map = L.map('map', { zoomControl: true }).setView(MAP_CENTER, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    L.control.scale({ metric: true, imperial: false }).addTo(map);

    const markerLayer = L.layerGroup().addTo(map);
    const circleLayer = L.layerGroup().addTo(map);
    const updatedEl = document.getElementById('updated');
    const refreshBtn = document.getElementById('refreshBtn');
    const locateBtn = document.getElementById('locateBtn');

    function cityPopup({name, wc, temp, humidity, wind, rain, snow, hazard}) {
      const badge = `<span class="badge" style="background:${colorForLevel(hazard.level)}">${hazard.level}</span>`;
      const tipsHtml = hazard.tips.map(t => `- ${t}`).join('\n');
      const incidentHtml = hazard.incident ? `
        <hr style="border:none;border-top:1px solid var(--bd);margin:8px 0"/>
        <b>⚠️ 안전사고</b> : <b>${hazard.incident.count}건</b><br/>
        <div style="margin-top:4px">사고사례 : ${hazard.incident.case}</div>
      ` : '';

      return `📍 <b>${name}</b><br/>
        🌤️ 상태: ${wc.description}
        <span style="display:inline-block;padding:2px 6px;border-radius:10px;border:1px solid #cfe;color:#456;background:#eef;margin-left:4px">${wc.main}</span><br/>
        🌡️ 기온: <b>${fmt(temp,0)}°C</b> · 💧 습도: ${fmt(humidity,0)}% · 🌬️ 풍속: <b>${fmt(wind,1)} m/s</b><br/>
        🌧️ 강수(현재): ${fmt(rain,1)} mm · ❄️ 적설(현재): ${fmt(snow,1)} mm<br/><br/>
        <b>🛡️ 이륜차 예방책</b> ${badge}<br/>
        상황 분류: <b>${hazard.type}</b>
        <pre>${tipsHtml}</pre>
        ${incidentHtml}
        <div class="muted" style="margin-top:6px">* 데이터: Open-Meteo(kma_seamless) · 시간대: ${KST}</div>`;
    }

    async function fetchCityWeather(city, retries=1) {
      const url = OPEN_METEO(city);
      try {
        const res = await withTimeoutAbort((signal) => fetch(url, { signal }), FETCH_TIMEOUT_MS);
        if (!res.ok) throw new Error(`Open-Meteo 응답 오류: ${res.status}`);
        const data = await res.json();
        const cur = data.current || {};
        const wc = weatherFromCode(cur.weather_code ?? 3);
        const temp = Number(cur.temperature_2m);
        const humidity = Number(cur.relative_humidity_2m);
        const wind = Number(cur.wind_speed_10m);
        const rain = Math.max(Number(cur.rain ?? 0), Number(cur.showers ?? 0));
        const snow = Number(cur.snowfall ?? 0);
        const hazard = assessHazard({ main: wc.main, tempC: temp, windMs: wind, rainMm: rain, snowMm: snow });
        return { wc, temp, humidity, wind, rain, snow, hazard };
      } catch (e) {
        if (retries > 0) {
          await sleep(400 + Math.random()*600);
          return fetchCityWeather(city, retries-1);
        }
        throw e;
      }
    }

    function drawCity(city, info) {
      const marker = L.marker([city.lat, city.lon]).addTo(markerLayer);
      marker.bindPopup(cityPopup({ name: city.name, ...info }));
      const r = 16;
      const color = colorForLevel(info.hazard.level);
      L.circleMarker([city.lat, city.lon], { radius: r, color, fillColor: color, fillOpacity: 0.25 }).addTo(circleLayer);
    }

    async function render(batch = cities) {
      markerLayer.clearLayers();
      circleLayer.clearLayers();
      updatedEl.textContent = '불러오는 중…';
      refreshBtn.setAttribute('aria-busy', 'true');

      for (const city of batch) {
        try {
          const info = await fetchCityWeather(city);
          drawCity(city, info);
        } catch (e) {
          const m = L.marker([city.lat, city.lon]).addTo(markerLayer);
          m.bindPopup(`❌ <b>${city.name}</b><br/>날씨 정보를 불러올 수 없습니다.<br/><span class="muted">${e?.message??e}</span>`);
        }
        await sleep(120);
      }

      updatedEl.textContent = `업데이트: ${nowStr()}`;
      refreshBtn.removeAttribute('aria-busy');
    }

    // --- 이벤트 -------------------------------------------------------------
    refreshBtn.addEventListener('click', () => render());
    window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'r') render(); });

    locateBtn.addEventListener('click', () => {
      if (!navigator.geolocation) return alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 13, { animate: true });
        },
        () => alert('위치 접근이 거부되었거나 실패했습니다.')
      );
    });

    // 초기 렌더
    render();
  });
  </script>
</body>
</html>
