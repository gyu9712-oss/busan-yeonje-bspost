<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Open-Meteo ë‚ ì”¨ ì§€ë„ â€” ë¶€ì‚° ì—°ì œ (ì´ë¥œì°¨ ì˜ˆë°©ìˆ˜ì¹™)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root { --bg:#fff; --ink:#111; --muted:#666; --card:rgba(255,255,255,.95); --shadow:0 2px 10px rgba(0,0,0,.1); --bd:#e5e7eb; }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0b0f14; --ink:#e6edf3; --muted:#9aa4af; --card:rgba(20,24,30,.9); --shadow:0 2px 12px rgba(0,0,0,.35); --bd:#263244; }
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); }
    #map { height:100vh; outline:none; }
    .legend, .toolbar {
      position:absolute; z-index:1000; background:var(--card); padding:8px 10px; border-radius:10px;
      box-shadow:var(--shadow); font:13px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px); border:1px solid var(--bd);
    }
    .legend { right:12px; bottom:12px; max-width:240px; }
    .legend div { display:flex; align-items:center; gap:6px; margin:3px 0; }
    .legend .sw { width:10px; height:10px; border-radius:2px; display:inline-block; border:1px solid rgba(0,0,0,.08) }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; color:#fff; font-size:12px }
    .muted { color:var(--muted); font-size:12px }
    pre { white-space:pre-wrap; margin:6px 0 0; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .toolbar { left:12px; top:12px; display:flex; align-items:center; gap:8px; }
    .toolbar button{ cursor:pointer; border:1px solid var(--bd); background:transparent; padding:7px 12px; border-radius:10px; font-weight:600; color:var(--ink); }
    .toolbar button[aria-busy="true"]{ opacity:.65; cursor:progress }
    .toolbar button:focus-visible { outline:2px solid #60a5fa; outline-offset:2px; }
  </style>
</head>
<body>
  <div id="map" aria-label="ë¶€ì‚° ì—°ì œ ë‚ ì”¨ ì§€ë„"></div>

  <div class="toolbar" role="region" aria-label="ë„êµ¬">
    <button id="refreshBtn" type="button" title="ìƒˆë¡œê³ ì¹¨ (R)" aria-live="polite">â†» ìƒˆë¡œê³ ì¹¨</button>
    <button id="locateBtn" type="button" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“ ë‚´ ìœ„ì¹˜</button>
    <span id="updated" class="muted">ì—…ë°ì´íŠ¸ ëŒ€ê¸°â€¦</span>
  </div>

  <div class="legend" role="note" aria-label="ìœ„í—˜ë„ ë²”ë¡€">
    <b>ìœ„í—˜ë„</b>
    <div><span class="sw" style="background:#10b981"></span> ë‚®ìŒ</div>
    <div><span class="sw" style="background:#3b82f6"></span> ë³´í†µ</div>
    <div><span class="sw" style="background:#f59e0b"></span> ì£¼ì˜</div>
    <div><span class="sw" style="background:#dc2626"></span> ê²½ê³„</div>
    <div><span class="sw" style="background:#b91c1c"></span> ì‹¬ê°</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
  <script>
    // --- ì„¤ì •/ìƒìˆ˜ -----------------------------------------------------------
    const KST = 'Asia/Seoul';
    const FETCH_TIMEOUT_MS = 12000;
    const MAP_CENTER = [35.1941016, 129.0706216]; // ë¶€ì‚° ì—°ì œ
    const OPEN_METEO = ({lat, lon}) =>
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
      + `&models=kma_seamless&current=temperature_2m,relative_humidity_2m,is_day,weather_code,rain,showers,snowfall,wind_speed_10m`
      + `&timezone=${encodeURIComponent(KST)}&windspeed_unit=ms`;

    const cities = [{ name: "ë¶€ì‚° ì—°ì œ", lat: MAP_CENTER[0], lon: MAP_CENTER[1] }];

    // --- ìœ í‹¸ --------------------------------------------------------------
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmt = (n, dp=0) => (n===undefined || n===null || Number.isNaN(n)) ? '-' : Number(n).toFixed(dp);
    const nowStr = () => new Date().toLocaleString('ko-KR', { timeZone: KST });

    function withTimeoutAbort(fetchFn, ms){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort('timeout'), ms);
      return fetchFn(controller.signal).finally(() => clearTimeout(id));
    }

    function weatherFromCode(code) {
      if (code === 0) return { main: "Clear", description: "ë§‘ìŒ" };
      if ([1,2,3].includes(code)) return { main: "Clouds", description: code===1?"ëŒ€ì²´ë¡œ ë§‘ìŒ": (code===2?"ë¶€ë¶„ íë¦¼":"íë¦¼") };
      if ([45,48].includes(code)) return { main: "Fog", description: "ì•ˆê°œ/ì§™ì€ ì•ˆê°œ" };
      if ([51,53,55,56,57].includes(code)) return { main: "Drizzle", description: "ì´ìŠ¬ë¹„/ì–¸ ì´ìŠ¬ë¹„" };
      if ([61,63,65,66,67,80,81,82].includes(code)) return { main: "Rain", description: "ë¹„/ì†Œë‚˜ê¸°" };
      if ([71,73,75,77,85,86].includes(code)) return { main: "Snow", description: "ëˆˆ/ì†Œë‚™ëˆˆ" };
      if ([95,96,99].includes(code)) return { main: "Thunderstorm", description: "ë‡Œìš°" };
      return { main: "Clouds", description: "íë¦¼" };
    }

    function colorForLevel(level) {
      return level === "ì‹¬ê°" ? "#b91c1c"
           : level === "ê²½ê³„" ? "#dc2626"
           : level === "ì£¼ì˜" ? "#f59e0b"
           : level === "ë³´í†µ" ? "#3b82f6"
           : "#10b981";
    }

    // --- í•µì‹¬: ìœ„í—˜ë„ í‰ê°€ + (ì‹ ê·œ) ê°•í’ ì•ˆì „ì‚¬ê³  ì •ë³´ -----------------------
    function assessHazard({ main, tempC, windMs, rainMm, snowMm }) {
      let level = "ë³´í†µ";
      let type = new Set([main]);
      let tips = [];
      let incident = null; // ğŸ”¸ ì¶”ê°€: ì•ˆì „ì‚¬ê³  ì •ë³´ ì»¨í…Œì´ë„ˆ

      const adopt = (lvl, typ, arr) => {
        const order = ["ë‚®ìŒ","ë³´í†µ","ì£¼ì˜","ê²½ê³„","ì‹¬ê°"];
        if (order.indexOf(lvl) > order.indexOf(level)) level = lvl;
        if (typ) type.add(typ);
        if (arr && arr.length) tips.push(...arr);
      };

      if (main === "Thunderstorm") {
        adopt(rainMm > 20 ? "ì‹¬ê°" : "ê²½ê³„", "ë‡Œìš°/í˜¸ìš°", [
          "ê°•í•œ ë¹„Â·ë²ˆê°œ ì‹œ ìš´í–‰ ì¤‘ì§€, ì‹¤ë‚´ ëŒ€ê¸°",
          "ì§€í•˜ì°¨ë„Â·í•˜ì²œ ì¸ê·¼ ì¹¨ìˆ˜ ë„ë¡œ ì§„ì… ê¸ˆì§€",
          "ì‹œì•¼ ê¸‰ê°: ì†ë„ 30% ê°ì†(ë¹„ìƒë“±ì€ ì •ì°¨ ì‹œ ì‚¬ìš©)"
        ]);
      } else if (main === "Rain" || main === "Drizzle") {
        adopt(rainMm > 30 ? "ì‹¬ê°" : (rainMm > 10 ? "ê²½ê³„" : "ì£¼ì˜"), "ë¹„/ì –ì€ ë…¸ë©´", [
          "ê°ì†(í‰ì†Œ ëŒ€ë¹„ 20~30%), ì œë™ê±°ë¦¬ 2ë°°",
          "ë§¨í™€Â·ë„ìƒ‰Â·ì² íŒÂ·ë¹—ë¬¼ë°›ì´ ìœ„ í†µê³¼ ê¸ˆì§€",
          "í—¬ë©§ ê¹€ì„œë¦¼ ë°©ì§€, ë°©ìˆ˜ ì¥ê°‘ ì°©ìš©"
        ]);
      } else if (main === "Snow") {
        adopt(snowMm > 5 ? "ê²½ê³„" : "ì£¼ì˜", "ëŒ€ì„¤/ê²°ë¹™", [
          "ë¸”ë™ì•„ì´ìŠ¤ ì‹œê°„ëŒ€ ìš´í–‰ ìì œÂ·ê·¼ë¬´ì‹œê°„ ì¡°ì •",
          "ê¸‰ê°€ê°ì† ê¸ˆì§€, ì§ì§„ ì‹œ í›„ë¥œ ì œë™ ë¹„ì¤‘ ë‚®ì¶”ê¸°",
          "ë°©í•œ ì¥ë¹„ ì°©ìš©, ì²´ì˜¨ ì €í•˜ ì‹œ ì¦‰ì‹œ íœ´ì‹"
        ]);
      } else if (main === "Fog") {
        adopt("ì£¼ì˜", "ì•ˆê°œ/ë°•ë¬´", [
          "ì €ì† ì£¼í–‰, ìƒì‹œ ë¡œìš°ë¹”/ì•ˆê°œë“±",
          "ì°¨ë¡œ ë³€ê²½ ìµœì†Œí™”, ì°¨ê°„ê±°ë¦¬ 4ì´ˆ+",
          "êµëŸ‰Â·í•´ì•ˆê°€ ë“± ì‹œì • ì•…í™” êµ¬ê°„ íšŒí”¼"
        ]);
      } else if (main === "Clear") {
        if (tempC >= 35) {
          adopt("ê²½ê³„", "í­ì—¼", [
            "30~60ë¶„ ê°„ê²© ê·¸ëŠ˜ íœ´ì‹Â·ìˆ˜ë¶„ ë³´ì¶©",
            "í†µí’í˜• ìì¼“/ì´ë„ˆ, ì¿¨ë§ íƒ€ì›” í™œìš©",
            "ì–´ì§€ëŸ¼Â·ë‘í†µ ë“± ì—´ì§ˆí™˜ ì§•í›„ ì‹œ ì¦‰ì‹œ ì¤‘ì§€"
          ]);
        } else if (tempC >= 33) {
          adopt("ì£¼ì˜", "í­ì—¼", [
            "ê·¸ëŠ˜ íœ´ì‹Â·ìˆ˜ë¶„ ë³´ì¶©",
            "ì§„í•œ ìƒ‰/ë‘êº¼ìš´ ì¥ë¹„ í”¼í•˜ê¸°",
            "ì¹´í˜ì¸ ê³¼ë‹¤ì„­ì·¨ ìì œ"
          ]);
        } else if (tempC <= -10) {
          adopt("ê²½ê³„", "í•œíŒŒ", [
            "í•¸ë“¤ì›Œë¨¸/í† ì‹œÂ·í•«íŒ©ìœ¼ë¡œ ì† ê°ê° ìœ ì§€",
            "ì•„ì¹¨ êµëŸ‰Â·ê·¸ëŠ˜ê¸¸ ë¸”ë™ì•„ì´ìŠ¤ ì£¼ì˜, ì„œí–‰",
            "ì‹œë™ ì „ íƒ€ì´ì–´ ê³µê¸°ì••Â·ê· ì—´ ì ê²€"
          ]);
        } else {
          adopt("ë‚®ìŒ", "ë§‘ìŒ", [ "PPE(í’€í˜ì´ìŠ¤ í—¬ë©§Â·ì¥ê°‘Â·ë¶€ì¸ Â·ë³´í˜¸ëŒ€) í•„ìˆ˜ ì°©ìš©" ]);
        }
      } else if (main === "Clouds") {
        adopt("ë³´í†µ", "êµ¬ë¦„/ê±´ì¡° ë…¸ë©´", [ "ê·œì • ì†ë„Â·ì°¨ê°„ê±°ë¦¬ 3ì´ˆ ì´ìƒ, í”¼ë¡œ ëˆ„ì  ì‹œ íœ´ì‹" ]);
      }

      // ğŸ”¸ ì¶”ê°€ ê·œì¹™: ê°•í’ ì‹œ(14 m/s ì´ìƒ) ì•ˆì „ì‚¬ê³  ì •ë³´ ë¶€ì—¬
      if (windMs >= 14) {
        const windLevel = windMs >= 20 ? "ì‹¬ê°" : "ê²½ê³„";
        adopt(windLevel, "ê°•í’/ëŒí’", [
          "íš¡í’ êµ¬ê°„(êµëŸ‰Â·í•´ì•ˆÂ·ê³ ê°€) íšŒí”¼, í†µê³¼ ì‹œ ì €ì†Â·ì°¨ë¡œ ì¤‘ì•™",
          "ëŒ€í˜•ì°¨ ì¶”ì›” ê¸ˆì§€(ì™€ë¥˜ ìœ„í—˜), ì ì¬ë¬¼ ì¬ê²°ì†",
          "ì°¨ì²´ë¥¼ ë°”ëŒ ë°©í–¥ìœ¼ë¡œ ì•½ê°„ ê¸°ìš¸ì—¬ ê· í˜• ìœ ì§€"
        ]);

        // âœ… ìš”êµ¬ì‚¬í•­ ë°˜ì˜: ì‚¬ê³  ê±´ìˆ˜ ë° ì‚¬ë¡€ í…ìŠ¤íŠ¸
        incident = {
          count: 1,
          case:
            "ìš°í¸ë¬¼ ë°°ì†¡ì„ ìœ„í•´ ì´ë™ì¤‘, ê°‘ì‘ìŠ¤ëŸ° ê°•í’ìœ¼ë¡œ ì´ë¥œì°¨ì™€ í•¨ê»˜ ì˜†ìœ¼ë¡œ ë„˜ì–´ì ¸ ì˜¤ë¥¸ìª½ ì†ëª© ì—¼ì¢Œ ë°œìƒ"
        };
      }

      tips.push("ê³µí†µ: T-CLOCS ì ê²€, PPE ì°©ìš©, ì°¨ê°„ê±°ë¦¬ 3~4ì´ˆ, ì ì¬ ê· í˜• ìœ ì§€");
      return { level, type: Array.from(type).join(" Â· "), tips: Array.from(new Set(tips)), incident };
    }

    // --- ì§€ë„ ì´ˆê¸°í™” --------------------------------------------------------
    const map = L.map('map', { zoomControl: true }).setView(MAP_CENTER, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    L.control.scale({ metric: true, imperial: false }).addTo(map);

    const markerLayer = L.layerGroup().addTo(map);
    const circleLayer = L.layerGroup().addTo(map);
    const updatedEl = document.getElementById('updated');
    const refreshBtn = document.getElementById('refreshBtn');
    const locateBtn = document.getElementById('locateBtn');

    function cityPopup({name, wc, temp, humidity, wind, rain, snow, hazard}) {
      const badge = `<span class="badge" style="background:${colorForLevel(hazard.level)}">${hazard.level}</span>`;
      const tipsHtml = hazard.tips.map(t => `- ${t}`).join('\n');

      // ğŸ”¸ incident ë¸”ë¡ì´ ìˆì„ ë•Œë§Œ ë Œë”
      const incidentHtml = hazard.incident ? `
        <hr style="border:none;border-top:1px solid var(--bd);margin:8px 0"/>
        <b>âš ï¸ ì•ˆì „ì‚¬ê³ </b> : <b>${hazard.incident.count}ê±´</b><br/>
        <div style="margin-top:4px">ì‚¬ê³ ì‚¬ë¡€ : ${hazard.incident.case}</div>
      ` : '';

      return `ğŸ“ <b>${name}</b><br/>
        ğŸŒ¤ï¸ ìƒíƒœ: ${wc.description}
        <span style="display:inline-block;padding:2px 6px;border-radius:10px;border:1px solid #cfe;color:#456;background:#eef;margin-left:4px">${wc.main}</span><br/>
        ğŸŒ¡ï¸ ê¸°ì˜¨: <b>${fmt(temp,0)}Â°C</b> Â· ğŸ’§ ìŠµë„: ${fmt(humidity,0)}% Â· ğŸŒ¬ï¸ í’ì†: <b>${fmt(wind,1)} m/s</b><br/>
        ğŸŒ§ï¸ ê°•ìˆ˜(í˜„ì¬): ${fmt(rain,1)} mm Â· â„ï¸ ì ì„¤(í˜„ì¬): ${fmt(snow,1)} mm<br/><br/>
        <b>ğŸ›¡ï¸ ì´ë¥œì°¨ ì˜ˆë°©ì±…</b> ${badge}<br/>
        ìƒí™© ë¶„ë¥˜: <b>${hazard.type}</b>
        <pre>${tipsHtml}</pre>
        ${incidentHtml}
        <div class="muted" style="margin-top:6px">* ë°ì´í„°: Open-Meteo(kma_seamless) Â· ì‹œê°„ëŒ€: ${KST}</div>`;
    }

    async function fetchCityWeather(city, retries=1) {
      const url = OPEN_METEO(city);
      try {
        const res = await withTimeoutAbort((signal) => fetch(url, { signal }), FETCH_TIMEOUT_MS);
        if (!res.ok) throw new Error(`Open-Meteo ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
        const data = await res.json();
        const cur = data.current || {};
        const wc = weatherFromCode(cur.weather_code ?? 3);
        const temp = Number(cur.temperature_2m);
        const humidity = Number(cur.relative_humidity_2m);
        const wind = Number(cur.wind_speed_10m);
        const rain = Math.max(Number(cur.rain ?? 0), Number(cur.showers ?? 0));
        const snow = Number(cur.snowfall ?? 0);
        const hazard = assessHazard({ main: wc.main, tempC: temp, windMs: wind, rainMm: rain, snowMm: snow });
        return { wc, temp, humidity, wind, rain, snow, hazard };
      } catch (e) {
        if (retries > 0) {
          await sleep(400 + Math.random()*600);
          return fetchCityWeather(city, retries-1);
        }
        throw e;
      }
    }

    function drawCity(city, info) {
      const marker = L.marker([city.lat, city.lon]).addTo(markerLayer);
      marker.bindPopup(cityPopup({ name: city.name, ...info }));
      const r = 16;
      const color = colorForLevel(info.hazard.level);
      L.circleMarker([city.lat, city.lon], { radius: r, color, fillColor: color, fillOpacity: 0.25 }).addTo(circleLayer);
    }

    async function render(batch = cities) {
      markerLayer.clearLayers();
      circleLayer.clearLayers();
      updatedEl.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      refreshBtn.setAttribute('aria-busy', 'true');

      for (const city of batch) {
        try {
          const info = await fetchCityWeather(city);
          drawCity(city, info);
        } catch (e) {
          const m = L.marker([city.lat, city.lon]).addTo(markerLayer);
          m.bindPopup(`âŒ <b>${city.name}</b><br/>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br/><span class="muted">${e?.message??e}</span>`);
        }
        await sleep(120);
      }

      updatedEl.textContent = `ì—…ë°ì´íŠ¸: ${nowStr()}`;
      refreshBtn.removeAttribute('aria-busy');
    }

    // --- ì´ë²¤íŠ¸ -------------------------------------------------------------
    refreshBtn.addEventListener('click', () => render());
    window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'r') render(); });

    locateBtn.addEventListener('click', () => {
      if (!navigator.geolocation) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 13, { animate: true });
        },
        () => alert('ìœ„ì¹˜ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
      );
    });

    // ì´ˆê¸° ë Œë”
    render();
  </script>
</body>
</html>
í•„ìš”í•˜ì‹œë©´ ì•ˆì „ì‚¬ê³  ë¸”ë¡ì„ ìƒë‹¨ì— ê°•ì¡°ë°°ì§€ë¡œ ê³ ì •(í•­ìƒ ë³´ì´ê²Œ) í•˜ê±°ë‚˜, **í’ì† ê¸°ì¤€ê°’(14 m/s)**ì„ ì˜µì…˜ìœ¼ë¡œ ë°”ê¿” ì„¤ì • íŒŒì¼ì—ì„œ ì¡°ì • ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ì–´ë“œë¦´ê²Œìš”.







ë‚˜ì˜ ë§:
ì½”ë“œê°€ ì—´ë¦¬ì§€ ì•Šì•„ìš” ë‹¤ì‹œ í•œë²ˆ ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”


ChatGPTì˜ ë§:

10s ë™ì•ˆ ìƒê°í•¨
í™•ì¸í•´ë³´ë‹ˆ, ì´ì „ ì½”ë“œê°€ Leaflet ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ íƒ€ì´ë°ê³¼ ê²¹ì¹˜ë©´ Lì´ ì•„ì§ ì •ì˜ë˜ì§€ ì•Šì•„ ì‹¤í–‰ì´ ë©ˆì¶œ ìˆ˜ ìˆì–´ìš”. ì´ë²ˆ ë²„ì „ì€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ(window.load) ì´í›„ì—ë§Œ ì´ˆê¸°í™”í•˜ë„ë¡ ë°”ê¿¨ìŠµë‹ˆë‹¤. ë˜í•œ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸/ìŠ¤íƒ€ì¼ ì£¼ì†Œë„ ê·¸ëŒ€ë¡œ ìœ íš¨í•©ë‹ˆë‹¤.

ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ êµì²´í•´ ì‹¤í–‰í•´ë³´ì„¸ìš”. (í’ì† 14 m/s ì´ìƒì´ë©´ íŒì—…ì— ì•ˆì „ì‚¬ê³  : 1ê±´ / ì‚¬ê³ ì‚¬ë¡€ : ...ê°€ í‘œì‹œë©ë‹ˆë‹¤.)

html
ì½”ë“œ ë³µì‚¬
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Open-Meteo ë‚ ì”¨ ì§€ë„ â€” ë¶€ì‚° ì—°ì œ (ì´ë¥œì°¨ ì˜ˆë°©ìˆ˜ì¹™)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root { --bg:#fff; --ink:#111; --muted:#666; --card:rgba(255,255,255,.95); --shadow:0 2px 10px rgba(0,0,0,.1); --bd:#e5e7eb; }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0b0f14; --ink:#e6edf3; --muted:#9aa4af; --card:rgba(20,24,30,.9); --shadow:0 2px 12px rgba(0,0,0,.35); --bd:#263244; }
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); }
    #map { height:100vh; outline:none; }
    .legend, .toolbar {
      position:absolute; z-index:1000; background:var(--card); padding:8px 10px; border-radius:10px;
      box-shadow:var(--shadow); font:13px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px); border:1px solid var(--bd);
    }
    .legend { right:12px; bottom:12px; max-width:260px; }
    .legend div { display:flex; align-items:center; gap:6px; margin:3px 0; }
    .legend .sw { width:10px; height:10px; border-radius:2px; display:inline-block; border:1px solid rgba(0,0,0,.08) }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; color:#fff; font-size:12px }
    .muted { color:var(--muted); font-size:12px }
    pre { white-space:pre-wrap; margin:6px 0 0; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .toolbar { left:12px; top:12px; display:flex; align-items:center; gap:8px; }
    .toolbar button{ cursor:pointer; border:1px solid var(--bd); background:transparent; padding:7px 12px; border-radius:10px; font-weight:600; color:var(--ink); }
    .toolbar button[aria-busy="true"]{ opacity:.65; cursor:progress }
    .toolbar button:focus-visible { outline:2px solid #60a5fa; outline-offset:2px; }
  </style>
</head>
<body>
  <div id="map" aria-label="ë¶€ì‚° ì—°ì œ ë‚ ì”¨ ì§€ë„"></div>

  <div class="toolbar" role="region" aria-label="ë„êµ¬">
    <button id="refreshBtn" type="button" title="ìƒˆë¡œê³ ì¹¨ (R)" aria-live="polite">â†» ìƒˆë¡œê³ ì¹¨</button>
    <button id="locateBtn" type="button" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“ ë‚´ ìœ„ì¹˜</button>
    <span id="updated" class="muted">ì—…ë°ì´íŠ¸ ëŒ€ê¸°â€¦</span>
  </div>

  <div class="legend" role="note" aria-label="ìœ„í—˜ë„ ë²”ë¡€">
    <b>ìœ„í—˜ë„</b>
    <div><span class="sw" style="background:#10b981"></span> ë‚®ìŒ</div>
    <div><span class="sw" style="background:#3b82f6"></span> ë³´í†µ</div>
    <div><span class="sw" style="background:#f59e0b"></span> ì£¼ì˜</div>
    <div><span class="sw" style="background:#dc2626"></span> ê²½ê³„</div>
    <div><span class="sw" style="background:#b91c1c"></span> ì‹¬ê°</div>
  </div>

  <!-- LeafletëŠ” ê·¸ëŒ€ë¡œ deferë¡œ ë¡œë“œ -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>

  <!-- í•µì‹¬ ìŠ¤í¬ë¦½íŠ¸: window.load ì´í›„ì—ë§Œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥ -->
  <script>
  window.addEventListener('load', () => {
    // --- ì„¤ì •/ìƒìˆ˜ -----------------------------------------------------------
    const KST = 'Asia/Seoul';
    const FETCH_TIMEOUT_MS = 12000;
    const MAP_CENTER = [35.1941016, 129.0706216]; // ë¶€ì‚° ì—°ì œ
    const OPEN_METEO = ({lat, lon}) =>
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
      + `&models=kma_seamless&current=temperature_2m,relative_humidity_2m,is_day,weather_code,rain,showers,snowfall,wind_speed_10m`
      + `&timezone=${encodeURIComponent(KST)}&windspeed_unit=ms`;

    const cities = [{ name: "ë¶€ì‚° ì—°ì œ", lat: MAP_CENTER[0], lon: MAP_CENTER[1] }];

    // --- ìœ í‹¸ --------------------------------------------------------------
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmt = (n, dp=0) => (n===undefined || n===null || Number.isNaN(n)) ? '-' : Number(n).toFixed(dp);
    const nowStr = () => new Date().toLocaleString('ko-KR', { timeZone: KST });

    function withTimeoutAbort(fetchFn, ms){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort('timeout'), ms);
      return fetchFn(controller.signal).finally(() => clearTimeout(id));
    }

    function weatherFromCode(code) {
      if (code === 0) return { main: "Clear", description: "ë§‘ìŒ" };
      if ([1,2,3].includes(code)) return { main: "Clouds", description: code===1?"ëŒ€ì²´ë¡œ ë§‘ìŒ": (code===2?"ë¶€ë¶„ íë¦¼":"íë¦¼") };
      if ([45,48].includes(code)) return { main: "Fog", description: "ì•ˆê°œ/ì§™ì€ ì•ˆê°œ" };
      if ([51,53,55,56,57].includes(code)) return { main: "Drizzle", description: "ì´ìŠ¬ë¹„/ì–¸ ì´ìŠ¬ë¹„" };
      if ([61,63,65,66,67,80,81,82].includes(code)) return { main: "Rain", description: "ë¹„/ì†Œë‚˜ê¸°" };
      if ([71,73,75,77,85,86].includes(code)) return { main: "Snow", description: "ëˆˆ/ì†Œë‚™ëˆˆ" };
      if ([95,96,99].includes(code)) return { main: "Thunderstorm", description: "ë‡Œìš°" };
      return { main: "Clouds", description: "íë¦¼" };
    }

    function colorForLevel(level) {
      return level === "ì‹¬ê°" ? "#b91c1c"
           : level === "ê²½ê³„" ? "#dc2626"
           : level === "ì£¼ì˜" ? "#f59e0b"
           : level === "ë³´í†µ" ? "#3b82f6"
           : "#10b981";
    }

    // --- ìœ„í—˜ë„ í‰ê°€ (+ ê°•í’ ì•ˆì „ì‚¬ê³  ë¸”ë¡) ---------------------------------
    function assessHazard({ main, tempC, windMs, rainMm, snowMm }) {
      let level = "ë³´í†µ";
      let type = new Set([main]);
      let tips = [];
      let incident = null; // 14 m/s ì´ìƒì‹œ ì±„ì›Œì§

      const adopt = (lvl, typ, arr) => {
        const order = ["ë‚®ìŒ","ë³´í†µ","ì£¼ì˜","ê²½ê³„","ì‹¬ê°"];
        if (order.indexOf(lvl) > order.indexOf(level)) level = lvl;
        if (typ) type.add(typ);
        if (arr && arr.length) tips.push(...arr);
      };

      if (main === "Thunderstorm") {
        adopt(rainMm > 20 ? "ì‹¬ê°" : "ê²½ê³„", "ë‡Œìš°/í˜¸ìš°", [
          "ê°•í•œ ë¹„Â·ë²ˆê°œ ì‹œ ìš´í–‰ ì¤‘ì§€, ì‹¤ë‚´ ëŒ€ê¸°",
          "ì§€í•˜ì°¨ë„Â·í•˜ì²œ ì¸ê·¼ ì¹¨ìˆ˜ ë„ë¡œ ì§„ì… ê¸ˆì§€",
          "ì‹œì•¼ ê¸‰ê°: ì†ë„ 30% ê°ì†(ë¹„ìƒë“±ì€ ì •ì°¨ ì‹œ ì‚¬ìš©)"
        ]);
      } else if (main === "Rain" || main === "Drizzle") {
        adopt(rainMm > 30 ? "ì‹¬ê°" : (rainMm > 10 ? "ê²½ê³„" : "ì£¼ì˜"), "ë¹„/ì –ì€ ë…¸ë©´", [
          "ê°ì†(í‰ì†Œ ëŒ€ë¹„ 20~30%), ì œë™ê±°ë¦¬ 2ë°°",
          "ë§¨í™€Â·ë„ìƒ‰Â·ì² íŒÂ·ë¹—ë¬¼ë°›ì´ ìœ„ í†µê³¼ ê¸ˆì§€",
          "í—¬ë©§ ê¹€ì„œë¦¼ ë°©ì§€, ë°©ìˆ˜ ì¥ê°‘ ì°©ìš©"
        ]);
      } else if (main === "Snow") {
        adopt(snowMm > 5 ? "ê²½ê³„" : "ì£¼ì˜", "ëŒ€ì„¤/ê²°ë¹™", [
          "ë¸”ë™ì•„ì´ìŠ¤ ì‹œê°„ëŒ€ ìš´í–‰ ìì œÂ·ê·¼ë¬´ì‹œê°„ ì¡°ì •",
          "ê¸‰ê°€ê°ì† ê¸ˆì§€, ì§ì§„ ì‹œ í›„ë¥œ ì œë™ ë¹„ì¤‘ ë‚®ì¶”ê¸°",
          "ë°©í•œ ì¥ë¹„ ì°©ìš©, ì²´ì˜¨ ì €í•˜ ì‹œ ì¦‰ì‹œ íœ´ì‹"
        ]);
      } else if (main === "Fog") {
        adopt("ì£¼ì˜", "ì•ˆê°œ/ë°•ë¬´", [
          "ì €ì† ì£¼í–‰, ìƒì‹œ ë¡œìš°ë¹”/ì•ˆê°œë“±",
          "ì°¨ë¡œ ë³€ê²½ ìµœì†Œí™”, ì°¨ê°„ê±°ë¦¬ 4ì´ˆ+",
          "êµëŸ‰Â·í•´ì•ˆê°€ ë“± ì‹œì • ì•…í™” êµ¬ê°„ íšŒí”¼"
        ]);
      } else if (main === "Clear") {
        if (tempC >= 35) {
          adopt("ê²½ê³„", "í­ì—¼", [
            "30~60ë¶„ ê°„ê²© ê·¸ëŠ˜ íœ´ì‹Â·ìˆ˜ë¶„ ë³´ì¶©",
            "í†µí’í˜• ìì¼“/ì´ë„ˆ, ì¿¨ë§ íƒ€ì›” í™œìš©",
            "ì–´ì§€ëŸ¼Â·ë‘í†µ ë“± ì—´ì§ˆí™˜ ì§•í›„ ì‹œ ì¦‰ì‹œ ì¤‘ì§€"
          ]);
        } else if (tempC >= 33) {
          adopt("ì£¼ì˜", "í­ì—¼", [
            "ê·¸ëŠ˜ íœ´ì‹Â·ìˆ˜ë¶„ ë³´ì¶©",
            "ì§„í•œ ìƒ‰/ë‘êº¼ìš´ ì¥ë¹„ í”¼í•˜ê¸°",
            "ì¹´í˜ì¸ ê³¼ë‹¤ì„­ì·¨ ìì œ"
          ]);
        } else if (tempC <= -10) {
          adopt("ê²½ê³„", "í•œíŒŒ", [
            "í•¸ë“¤ì›Œë¨¸/í† ì‹œÂ·í•«íŒ©ìœ¼ë¡œ ì† ê°ê° ìœ ì§€",
            "ì•„ì¹¨ êµëŸ‰Â·ê·¸ëŠ˜ê¸¸ ë¸”ë™ì•„ì´ìŠ¤ ì£¼ì˜, ì„œí–‰",
            "ì‹œë™ ì „ íƒ€ì´ì–´ ê³µê¸°ì••Â·ê· ì—´ ì ê²€"
          ]);
        } else {
          adopt("ë‚®ìŒ", "ë§‘ìŒ", [ "PPE(í’€í˜ì´ìŠ¤ í—¬ë©§Â·ì¥ê°‘Â·ë¶€ì¸ Â·ë³´í˜¸ëŒ€) í•„ìˆ˜ ì°©ìš©" ]);
        }
      } else if (main === "Clouds") {
        adopt("ë³´í†µ", "êµ¬ë¦„/ê±´ì¡° ë…¸ë©´", [ "ê·œì • ì†ë„Â·ì°¨ê°„ê±°ë¦¬ 3ì´ˆ ì´ìƒ, í”¼ë¡œ ëˆ„ì  ì‹œ íœ´ì‹" ]);
      }

      // ê°•í’ ì¡°ê±´(14 m/s ì´ìƒ)
      if (windMs >= 14) {
        const windLevel = windMs >= 20 ? "ì‹¬ê°" : "ê²½ê³„";
        adopt(windLevel, "ê°•í’/ëŒí’", [
          "íš¡í’ êµ¬ê°„(êµëŸ‰Â·í•´ì•ˆÂ·ê³ ê°€) íšŒí”¼, í†µê³¼ ì‹œ ì €ì†Â·ì°¨ë¡œ ì¤‘ì•™",
          "ëŒ€í˜•ì°¨ ì¶”ì›” ê¸ˆì§€(ì™€ë¥˜ ìœ„í—˜), ì ì¬ë¬¼ ì¬ê²°ì†",
          "ì°¨ì²´ë¥¼ ë°”ëŒ ë°©í–¥ìœ¼ë¡œ ì•½ê°„ ê¸°ìš¸ì—¬ ê· í˜• ìœ ì§€"
        ]);
        incident = {
          count: 1,
          case: "ìš°í¸ë¬¼ ë°°ì†¡ì„ ìœ„í•´ ì´ë™ì¤‘, ê°‘ì‘ìŠ¤ëŸ° ê°•í’ìœ¼ë¡œ ì´ë¥œì°¨ì™€ í•¨ê»˜ ì˜†ìœ¼ë¡œ ë„˜ì–´ì ¸ ì˜¤ë¥¸ìª½ ì†ëª© ì—¼ì¢Œ ë°œìƒ"
        };
      }

      tips.push("ê³µí†µ: T-CLOCS ì ê²€, PPE ì°©ìš©, ì°¨ê°„ê±°ë¦¬ 3~4ì´ˆ, ì ì¬ ê· í˜• ìœ ì§€");
      return { level, type: Array.from(type).join(" Â· "), tips: Array.from(new Set(tips)), incident };
    }

    // --- ì§€ë„ ì´ˆê¸°í™” --------------------------------------------------------
    const map = L.map('map', { zoomControl: true }).setView(MAP_CENTER, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    L.control.scale({ metric: true, imperial: false }).addTo(map);

    const markerLayer = L.layerGroup().addTo(map);
    const circleLayer = L.layerGroup().addTo(map);
    const updatedEl = document.getElementById('updated');
    const refreshBtn = document.getElementById('refreshBtn');
    const locateBtn = document.getElementById('locateBtn');

    function cityPopup({name, wc, temp, humidity, wind, rain, snow, hazard}) {
      const badge = `<span class="badge" style="background:${colorForLevel(hazard.level)}">${hazard.level}</span>`;
      const tipsHtml = hazard.tips.map(t => `- ${t}`).join('\n');
      const incidentHtml = hazard.incident ? `
        <hr style="border:none;border-top:1px solid var(--bd);margin:8px 0"/>
        <b>âš ï¸ ì•ˆì „ì‚¬ê³ </b> : <b>${hazard.incident.count}ê±´</b><br/>
        <div style="margin-top:4px">ì‚¬ê³ ì‚¬ë¡€ : ${hazard.incident.case}</div>
      ` : '';

      return `ğŸ“ <b>${name}</b><br/>
        ğŸŒ¤ï¸ ìƒíƒœ: ${wc.description}
        <span style="display:inline-block;padding:2px 6px;border-radius:10px;border:1px solid #cfe;color:#456;background:#eef;margin-left:4px">${wc.main}</span><br/>
        ğŸŒ¡ï¸ ê¸°ì˜¨: <b>${fmt(temp,0)}Â°C</b> Â· ğŸ’§ ìŠµë„: ${fmt(humidity,0)}% Â· ğŸŒ¬ï¸ í’ì†: <b>${fmt(wind,1)} m/s</b><br/>
        ğŸŒ§ï¸ ê°•ìˆ˜(í˜„ì¬): ${fmt(rain,1)} mm Â· â„ï¸ ì ì„¤(í˜„ì¬): ${fmt(snow,1)} mm<br/><br/>
        <b>ğŸ›¡ï¸ ì´ë¥œì°¨ ì˜ˆë°©ì±…</b> ${badge}<br/>
        ìƒí™© ë¶„ë¥˜: <b>${hazard.type}</b>
        <pre>${tipsHtml}</pre>
        ${incidentHtml}
        <div class="muted" style="margin-top:6px">* ë°ì´í„°: Open-Meteo(kma_seamless) Â· ì‹œê°„ëŒ€: ${KST}</div>`;
    }

    async function fetchCityWeather(city, retries=1) {
      const url = OPEN_METEO(city);
      try {
        const res = await withTimeoutAbort((signal) => fetch(url, { signal }), FETCH_TIMEOUT_MS);
        if (!res.ok) throw new Error(`Open-Meteo ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
        const data = await res.json();
        const cur = data.current || {};
        const wc = weatherFromCode(cur.weather_code ?? 3);
        const temp = Number(cur.temperature_2m);
        const humidity = Number(cur.relative_humidity_2m);
        const wind = Number(cur.wind_speed_10m);
        const rain = Math.max(Number(cur.rain ?? 0), Number(cur.showers ?? 0));
        const snow = Number(cur.snowfall ?? 0);
        const hazard = assessHazard({ main: wc.main, tempC: temp, windMs: wind, rainMm: rain, snowMm: snow });
        return { wc, temp, humidity, wind, rain, snow, hazard };
      } catch (e) {
        if (retries > 0) {
          await sleep(400 + Math.random()*600);
          return fetchCityWeather(city, retries-1);
        }
        throw e;
      }
    }

    function drawCity(city, info) {
      const marker = L.marker([city.lat, city.lon]).addTo(markerLayer);
      marker.bindPopup(cityPopup({ name: city.name, ...info }));
      const r = 16;
      const color = colorForLevel(info.hazard.level);
      L.circleMarker([city.lat, city.lon], { radius: r, color, fillColor: color, fillOpacity: 0.25 }).addTo(circleLayer);
    }

    async function render(batch = cities) {
      markerLayer.clearLayers();
      circleLayer.clearLayers();
      updatedEl.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      refreshBtn.setAttribute('aria-busy', 'true');

      for (const city of batch) {
        try {
          const info = await fetchCityWeather(city);
          drawCity(city, info);
        } catch (e) {
          const m = L.marker([city.lat, city.lon]).addTo(markerLayer);
          m.bindPopup(`âŒ <b>${city.name}</b><br/>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br/><span class="muted">${e?.message??e}</span>`);
        }
        await sleep(120);
      }

      updatedEl.textContent = `ì—…ë°ì´íŠ¸: ${nowStr()}`;
      refreshBtn.removeAttribute('aria-busy');
    }

    // --- ì´ë²¤íŠ¸ -------------------------------------------------------------
    refreshBtn.addEventListener('click', () => render());
    window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'r') render(); });

    locateBtn.addEventListener('click', () => {
      if (!navigator.geolocation) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 13, { animate: true });
        },
        () => alert('ìœ„ì¹˜ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
      );
    });

    // ì´ˆê¸° ë Œë”
    render();
  });
  </script>
</body>
</html>
